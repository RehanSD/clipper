FROM nvidia/cuda:10.0-devel-ubuntu16.04

LABEL maintainer="Rehan Durrani <rdurrani@berkeley.edu>"

RUN apt-get update \
 && apt-get install -y --no-install-recommends \
	build-essential \
	curl \
	wget \
	software-properties-common \
	python3-pip \
 && add-apt-repository -y ppa:jonathonf/python-3.6 \
 && apt-get update \
 && apt-get install -y python3.6 python3.6-dev \
 && apt-get clean \
 && rm -rf /var/lib/apt/lists/*

RUN python3.6 -m pip install --no-cache-dir -U pip
RUN python3.6 -m pip install --no-cache-dir -U setuptools
RUN ln -s /usr/bin/pip3.6 /usr/bin/pip
RUN ln -s /usr/bin/python3.6 /usr/bin/python

RUN pip install -U --user pip six numpy wheel setuptools mock keras_applications==1.0.6 --no-deps keras_preprocessing==1.0.5 --no-deps

RUN apt-get install -y openjdk-8-jdk \
 && echo "deb [arch=amd64] http://storage.googleapis.com/bazel-apt stable jdk1.8" | tee /etc/apt/sources.list.d/bazel.list \
 && curl https://bazel.build/bazel-release.pub.gpg | apt-key add - \
 && apt-get update && sudo apt-get install bazel

RUN apt-get install --no-install-recommends \
	libcudnn7=7.4.1.5-1+cuda10.1 \
	libcudnn7-dev=7.4.1.5-1+cuda10.1 \
 && apt-get update -qq \
 && apt-get install nvinfer-runtime-trt-repo-ubuntu1604-5.0.2-ga-cuda10.1 \
 && apt-get update -qq \
 && apt-get install -y --no-install-recommends libnvinfer-dev=5.0.2-1+cuda10.1

RUN git clone https://github.com/tensorflow/tensorflow.git \

WORKDIR tensorflow

RUN git checkout r1.13

RUN ./configure

RUN bazel build --config=opt --config=cuda //tensorflow/tools/pip_package:build_pip_package

WORKDIR /

RUN apt-get update -qq

RUN apt-get install -y libssl-dev libffi-dev

RUN mkdir -p /model \
      && apt-get update -qq \
      && apt-get install -y -qq libzmq5 libzmq5-dev redis-server libsodium18

RUN pip install tensorflow-gpu==1.3.0rc0 cloudpickle==0.5.* pyopenssl pyzmq==17.0.* prometheus_client==0.1.* \
    jsonschema==2.6.* redis==2.10.* psutil==5.4.* flask==0.12.2 \
    numpy==1.14.*

COPY clipper_admin /clipper_admin/

RUN cd /clipper_admin \
                && pip install .

WORKDIR /container

COPY containers/python/__init__.py containers/python/rpc.py /container/

COPY monitoring/metrics_config.yaml /container/

ENV CLIPPER_MODEL_PATH=/model

HEALTHCHECK --interval=3s --timeout=3s --retries=1 CMD test -f /model_is_ready.check || exit 1

COPY containers/python/tf_container.py containers/python/container_entry.sh /container/

CMD ["/container/container_entry.sh", "tensorflow-container", "/container/tf_container.py"]

# vim: set filetype=dockerfile:
